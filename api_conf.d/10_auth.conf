# =========================================================
# 10_auth.conf (server-level snippet)
# Rolle:
# - /auth/* -> auth_service
# - ABER: Auth-Module hängen am Prefix /auth (Fastify)
# - Ausnahme: /auth/healthz ist Gateway-Alias auf upstream /healthz
# =========================================================

# Internal Guard: Tenant-Existenz via auth-service
location = /_guard/tenant {
  internal;

  proxy_connect_timeout 2s;
  proxy_read_timeout    2s;
  proxy_send_timeout    2s;

  proxy_pass_request_body off;
  proxy_set_header Content-Length "";

  proxy_set_header X-Tenant-Id $tenant_from_header;

  proxy_pass http://$auth_upstream_host/internal/tenants/$tenant_from_header;
}

# Alias: Gateway /auth/healthz -> Upstream /healthz
location = /auth/healthz {
  if ($request_method !~ ^(GET|OPTIONS)$) {
    return 405 '{"status":405,"error":{"code":"METHOD_NOT_ALLOWED","message":"Method not allowed."},"request_id":"$gateway_request_id"}\n';
  }
  limit_req zone=auth_limit burst=10 nodelay;
  limit_req zone=auth_tenant_limit burst=10 nodelay;

  proxy_http_version 1.1;
  proxy_set_header Connection "";

  proxy_connect_timeout 5s;
  proxy_send_timeout    60s;
  proxy_read_timeout    60s;

  proxy_pass http://$auth_upstream_host/healthz;
}

# Alles andere bleibt mit /auth/* erhalten (KEIN rewrite!)
location ^~ /auth/ {
  limit_req zone=auth_limit burst=10 nodelay;
  limit_req zone=auth_tenant_limit burst=10 nodelay;
  if ($request_method !~ ^(GET|POST|OPTIONS)$) {
    return 405 '{"status":405,"error":{"code":"METHOD_NOT_ALLOWED","message":"Method not allowed."},"request_id":"$gateway_request_id"}\n';
  }

  # Missing-Header (400) bleibt global via $tenant_reject_missing
  auth_request /_guard/tenant;

  # Guard-Fehler auf eigene Responses mappen
  error_page 403 404 = @tenant_unknown;
  error_page 500 502 503 504 = @tenant_registry_down;

  proxy_http_version 1.1;
  proxy_set_header Connection "";

  proxy_connect_timeout 5s;
  proxy_send_timeout    60s;
  proxy_read_timeout    60s;

  # Header explizit setzen (zusätzlich zu server-level defaults)
  proxy_set_header Host $host;
  proxy_set_header X-Request-Id $gateway_request_id;
  # UUID-validierter Tenant-Header aus dem Gateway-Map
  proxy_set_header X-Tenant-Id $tenant_from_header;

  proxy_pass http://$auth_upstream_host;
}

location @tenant_unknown {
  default_type application/json;
  return 403 '{"status":403,"error":{"code":"TENANT_UNKNOWN","message":"Unknown tenant."},"request_id":"$gateway_request_id"}\n';
}

location @tenant_registry_down {
  default_type application/json;
  return 503 '{"status":503,"error":{"code":"TENANT_REGISTRY_UNAVAILABLE","message":"Tenant registry unavailable."},"request_id":"$gateway_request_id"}\n';
}
