# =========================================================
# 00_health.conf (server-level snippet)
# Rolle:
# - nur location{} Snippets
# - Health-Routen (Gateway self + Service checks)
# =========================================================

# ---------------------------
# Gateway self-check
# ---------------------------
location = /healthz {
  if ($request_method !~ ^(GET|HEAD|OPTIONS)$) {
    return 405 '{"status":405,"error":{"code":"METHOD_NOT_ALLOWED","message":"Method not allowed."},"request_id":"$gateway_request_id"}\n';
  }
  default_type application/json;
  return 200 '{"status":"ok","service":"nginx-gateway"}\n';
}

# ---------------------------
# Gateway stack health (minimal)
# ---------------------------
location ~ ^/health/stack/?$ {
  if ($request_method !~ ^(GET|HEAD|OPTIONS)$) {
    return 405 '{"status":405,"error":{"code":"METHOD_NOT_ALLOWED","message":"Method not allowed."},"request_id":"$gateway_request_id"}\n';
  }
  default_type application/json;
  return 200 '{"status":"ok","service":"gateway","ts":"$time_iso8601"}\n';
}

# ---------------------------
# Auth-Service health
# -> GET /health/auth  =>  auth-service:3000 /healthz
# ---------------------------
location = /health/auth {
  if ($request_method !~ ^(GET|HEAD|OPTIONS)$) {
    return 405 '{"status":405,"error":{"code":"METHOD_NOT_ALLOWED","message":"Method not allowed."},"request_id":"$gateway_request_id"}\n';
  }
  proxy_http_version 1.1;
  proxy_set_header Connection "";

  proxy_pass http://$auth_upstream_host/healthz;

  # Optional: kurze Timeouts fÃ¼r Health
  proxy_connect_timeout 2s;
  proxy_send_timeout    2s;
  proxy_read_timeout    2s;
}

# ---------------------------
# Profile-Service health
# -> GET /health/profile  =>  profile-service:4000 /health
# ---------------------------
location = /health/profile {
  if ($request_method !~ ^(GET|HEAD|OPTIONS)$) {
    return 405 '{"status":405,"error":{"code":"METHOD_NOT_ALLOWED","message":"Method not allowed."},"request_id":"$gateway_request_id"}\n';
  }
  proxy_http_version 1.1;
  proxy_set_header Connection "";

  proxy_pass http://$profile_upstream_host/health;

  proxy_connect_timeout 2s;
  proxy_send_timeout    2s;
  proxy_read_timeout    2s;
}

# ---------------------------------------------------------
# Readiness (minimal): schneller upstream check
# ---------------------------------------------------------
location = /readyz {
  if ($request_method !~ ^(GET|HEAD|OPTIONS)$) {
    return 405 '{"status":405,"error":{"code":"METHOD_NOT_ALLOWED","message":"Method not allowed."},"request_id":"$gateway_request_id"}\n';
  }
  proxy_http_version 1.1;
  proxy_set_header Connection "";

  proxy_intercept_errors on;
  error_page 502 503 504 = @ready_not_ready;

  proxy_connect_timeout 1s;
  proxy_send_timeout    1s;
  proxy_read_timeout    1s;
  proxy_pass http://$auth_upstream_host/healthz;
}

location @ready_not_ready {
  default_type application/json;
  return 503 '{"status":503,"error":{"code":"NOT_READY","message":"Gateway dependencies are not ready."},"request_id":"$gateway_request_id"}\n';
}
