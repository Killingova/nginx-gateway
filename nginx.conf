# =========================================================
# nginx.conf (Root)
# Verantwortung:
# - Worker/Events
# - http{} Basis-Defaults (Timeouts, Logging, Proxy-Defaults)
# - include: api_gateway.conf (http-level maps+upstreams)
# - include: server blocks (conf.d/*.conf)
# =========================================================

env GATEWAY_ENV;

user  nginx;
worker_processes auto;

error_log  /dev/stderr info;
pid        /var/run/nginx.pid;

events {
  worker_connections 4096;
}

http {
  include       /etc/nginx/mime.types;
  default_type  application/json;
  underscores_in_headers off;
  ignore_invalid_headers on;

  # ---------------------------------------------------------
  # HTTP-Level Definitionen (upstream + map)
  # ---------------------------------------------------------
  include /etc/nginx/api_gateway.conf;

  # ---------------------------------------------------------
  # Logging (Container-Style)
  # - JSON schema fuer zentrale Auswertung
  # ---------------------------------------------------------
  log_format main_json escape=json '{'
    '"ts":"$time_iso8601",'
    '"request_id":"$gateway_request_id",'
    '"tenant_id":"$tenant_from_header",'
    '"remote_addr":"$remote_addr",'
    '"method":"$request_method",'
    '"uri":"$request_uri",'
    '"status":$status,'
    '"bytes_sent":$bytes_sent,'
    '"request_time":$request_time,'
    '"upstream_addr":"$upstream_addr",'
    '"upstream_status":"$upstream_status",'
    '"upstream_response_time":"$upstream_response_time",'
    '"referer":"$http_referer",'
    '"user_agent":"$http_user_agent"'
  '}';

  access_log /dev/stdout main_json;

  # ---------------------------------------------------------
  # Transport/TCP
  # ---------------------------------------------------------
  sendfile        on;
  tcp_nopush      on;
  tcp_nodelay     on;

  keepalive_timeout  65s;
  keepalive_requests 1000;

  client_header_timeout 10s;
  client_body_timeout   10s;
  send_timeout          30s;
  reset_timedout_connection on;

  client_header_buffer_size 4k;
  large_client_header_buffers 4 16k;
  client_body_buffer_size 32k;

  client_max_body_size 10m;

  # ---------------------------------------------------------
  # Trust Boundary (Real-IP nur von trusted proxy hops)
  # Ohne trusted hop bleibt remote_addr die Quell-IP, XFF wird ignoriert.
  # ---------------------------------------------------------
  real_ip_header X-Forwarded-For;
  real_ip_recursive on;
  set_real_ip_from 127.0.0.1;
  # Docker bridge/networks (an Umgebung anpassen)
  set_real_ip_from 172.18.0.0/16;

  # ---------------------------------------------------------
  # Rate Limiting (Zonen)
  # ---------------------------------------------------------
  limit_req_zone $binary_remote_addr zone=auth_limit:10m rate=10r/m;
  limit_req_zone $auth_limit_key     zone=auth_tenant_limit:20m rate=10r/m;
  limit_req_zone $binary_remote_addr zone=api_limit:10m  rate=60r/m;
  limit_conn_zone $binary_remote_addr zone=conn_limit:10m;
  limit_conn_status 429;

  # ---------------------------------------------------------
  # Security Header (global)
  # ---------------------------------------------------------
  add_header X-Frame-Options DENY always;
  add_header X-Content-Type-Options nosniff always;
  add_header Referrer-Policy no-referrer always;
  add_header Permissions-Policy "accelerometer=(), camera=(), geolocation=(), microphone=()" always;
  add_header Content-Security-Policy "frame-ancestors 'none'" always;

  # Weniger Fingerprinting
  server_tokens off;

  # ---------------------------------------------------------
  # Docker DNS Resolver (f端r "resolve" in upstream)
  # ---------------------------------------------------------
  resolver 127.0.0.11 valid=5s ipv6=off;
  resolver_timeout 2s;

  # ---------------------------------------------------------
  # Proxy Defaults (global)
  # ---------------------------------------------------------
  proxy_http_version 1.1;
  proxy_set_header Connection "";

  proxy_set_header Host              $host;
  proxy_set_header X-Real-IP         $remote_addr;
  proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Host  $host;
  proxy_set_header X-Forwarded-Proto $scheme;

  # Request-ID f端r Tracing (Upstreams sollten das loggen)
  proxy_set_header X-Request-Id      $gateway_request_id;
  proxy_set_header traceparent       $traceparent_safe;
  proxy_set_header tracestate        $tracestate_safe;

  # Untrusted forwarding headers nicht blind durchreichen.
  proxy_set_header Forwarded         "";
  proxy_set_header X-Original-URI    "";
  proxy_set_header X-Original-URL    "";

  proxy_next_upstream        error timeout invalid_header http_502 http_503 http_504;
  proxy_next_upstream_tries  2;

  proxy_connect_timeout  2s;
  proxy_send_timeout     30s;
  proxy_read_timeout     30s;

  # Buffering ok f端r JSON. F端r SSE/Streaming pro-location: proxy_buffering off;
  proxy_buffering         on;
  proxy_buffer_size       8k;
  proxy_buffers           8 16k;
  proxy_busy_buffers_size 32k;

  # ---------------------------------------------------------
  # Server Blocks
  # ---------------------------------------------------------
  include /etc/nginx/conf.d/*.conf;
}
