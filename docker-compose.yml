# ==============================================================================
# Docker Compose: NGINX Gateway – Senior/Production-like Dev Setup
# ==============================================================================
# Ziele:
# - Einziger Public Entry-Point der Plattform (Host -> Gateway)
# - Saubere Security Defaults (no-new-privileges, read_only, tmpfs, pids_limit)
# - Nur lokal publishen, wenn gewünscht (Option A) – oder öffentlich (Option B)
# - Konfig & Zertifikate read-only gemountet
# - Logging begrenzen (Schutz vor Disk-Flood)
# ==============================================================================

name: gateway-stack

services:
  nginx-gateway:
    image: myregistry/nginx-gateway:latest
    container_name: nginx-gateway
    restart: unless-stopped

    build:
      context: .
      dockerfile: Dockerfile

    networks:
      - paradox_net

    # --------------------------------------------------------------------------
    # Ports:
    # Option A (empfohlen für DEV auf VM): NUR lokal binden (kein 0.0.0.0)
    # Option B: extern erreichbar (wie bisher)
    # --------------------------------------------------------------------------
    ports:
      - "127.0.0.1:8080:80"
      - "127.0.0.1:443:443"
      - "127.0.0.1:8443:443"
      - "127.0.0.1:18080:18080"
      # - "8080:80"
      # - "443:443"
      # - "8443:443"
      # - "18080:18080"

    # --------------------------------------------------------------------------
    # Security Hardening
    # --------------------------------------------------------------------------
    security_opt:
      - no-new-privileges:true

    # NGINX kann read-only laufen, weil wir tmpfs für Cache/Run bereitstellen
    read_only: true
    tmpfs:
      - /var/cache/nginx
      - /var/run

    # Ressourcen-/Prozesslimits (kein Swarm nötig)
    pids_limit: 200

    # Capability-Minimierung fuer Port-80 Bind Strategie:
    # - root master + worker drop (nginx user)
    # - nur notwendige Caps fuer bind + user switching
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
      - CHOWN
      - SETUID
      - SETGID

    # --------------------------------------------------------------------------
    # Volumes (alles read-only)
    # --------------------------------------------------------------------------
    volumes:
      # Hauptkonfigurationen
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./api_gateway.conf:/etc/nginx/api_gateway.conf:ro

      # Include-Directories
      - ./api_conf.d:/etc/nginx/api_conf.d:ro
      - ./conf.d:/etc/nginx/conf.d:ro

      # TLS Zertifikate (DEV: self-signed; PROD: echtes cert bundle)
      - ./certs:/etc/nginx/certs:ro

    # --------------------------------------------------------------------------
    # Logging begrenzen (Schutz vor Log-Flood)
    # --------------------------------------------------------------------------
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

    # --------------------------------------------------------------------------
    # Healthcheck
    # - nutzt nginx -t für Config-Validierung + internen HTTP-Check
    # - falls dein Image kein wget/curl hat -> nur nginx -t verwenden
    # --------------------------------------------------------------------------
    healthcheck:
      test: ["CMD-SHELL", "nginx -t >/dev/null 2>&1 || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 10
      start_period: 5s

networks:
  paradox_net:
    external: true
