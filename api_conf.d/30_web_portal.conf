# =========================================================
# 30_web_portal.conf (server-level snippet)
# Rolle:
# - Catch-all fuer SPA-Frontend
# - /auth und /profiles werden durch prioritaere ^~ Locations abgefangen
# =========================================================

location / {
  # API calls sollten auf expliziten Prefixes landen; Catch-all ist UI.
  if ($request_method !~ ^(GET|HEAD|OPTIONS)$) {
    return 405 '{"status":405,"error":{"code":"METHOD_NOT_ALLOWED","message":"Method not allowed."},"request_id":"$gateway_request_id"}\n';
  }

  proxy_http_version 1.1;
  proxy_set_header Connection "";

  proxy_set_header Host              $host;
  proxy_set_header X-Request-Id      $gateway_request_id;
  proxy_set_header X-Forwarded-Proto $scheme;

  proxy_connect_timeout 5s;
  proxy_send_timeout    30s;
  proxy_read_timeout    30s;

  proxy_pass http://$web_portal_upstream_host;
}
