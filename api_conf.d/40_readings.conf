# =========================================================
# 40_readings.conf (server-level snippet)
# Rolle:
# - /readings* -> profile-service
# =========================================================

location ^~ /readings {
  limit_req zone=api_limit burst=30 nodelay;
  if ($request_method !~ ^(GET|POST|PUT|PATCH|DELETE|OPTIONS)$) {
    return 405 '{"status":405,"error":{"code":"METHOD_NOT_ALLOWED","message":"Method not allowed."},"request_id":"$gateway_request_id"}\n';
  }

  # Method-basierte Scope-Policy am Edge:
  # - read methods -> profile:read
  # - write methods -> profile:write
  set $required_scope "profile:write";
  set $required_role "";
  set $authz_header_forward $http_authorization;
  set $tenant_header_forward $tenant_from_header;
  if ($request_method ~ ^(GET|HEAD|OPTIONS)$) {
    set $required_scope "profile:read";
  }

  auth_request /_auth_verify;
  error_page 401 = @gw_err_401;
  error_page 403 = @gw_err_403;
  error_page 500 502 503 504 = @auth_verify_unavailable;
  auth_request_set $auth_user_id   $upstream_http_x_user_id;
  auth_request_set $auth_tenant_id $upstream_http_x_tenant_id;

  proxy_http_version 1.1;
  proxy_set_header Connection "";

  proxy_set_header Host $host;
  proxy_set_header X-Request-Id $gateway_request_id;
  proxy_set_header X-Tenant-Id $auth_tenant_id;
  proxy_set_header X-User-Id $auth_user_id;
  proxy_set_header Authorization "";

  proxy_connect_timeout 5s;
  proxy_send_timeout    60s;
  proxy_read_timeout    60s;

  proxy_pass http://$profile_upstream_host;
}

