# =========================================================
# 25_authz.conf (server-level snippet)
# Rolle:
# - Edge AuthZ ueber auth_request gegen auth-service
# - NGINX bleibt policy-enforcer, Auth-Service verifiziert JWT+Claims
# =========================================================

location = /_auth_verify {
  internal;

  proxy_pass_request_body off;
  proxy_set_header Content-Length "";

  proxy_set_header Authorization $authz_header_forward;
  proxy_set_header X-Tenant-Id   $tenant_header_forward;
  proxy_set_header X-Request-Id  $gateway_request_id;
  proxy_set_header X-Required-Scope $required_scope;
  proxy_set_header X-Required-Role  $required_role;

  proxy_connect_timeout 2s;
  proxy_send_timeout    5s;
  proxy_read_timeout    5s;

  proxy_pass http://$auth_upstream_host/internal/verify;
}

location @auth_verify_unavailable {
  default_type application/json;
  return 503 '{"status":503,"error":{"code":"AUTH_VERIFY_UNAVAILABLE","message":"Auth verification unavailable."},"request_id":"$gateway_request_id"}\n';
}
