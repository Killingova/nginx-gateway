# =========================================================
# api_gateway.conf (http-level include)
# Resolver-aware upstream routing fuer OSS NGINX:
# - Hostnames werden via variable proxy_pass + resolver ausgewertet.
# - Dadurch restart-resilient bei Container-IP Wechsel.
# =========================================================

map "" $auth_upstream_host {
  default "auth-service:3000";
}

map "" $profile_upstream_host {
  default "profile-service:4000";
}

map "" $web_portal_upstream_host {
  default "web-portal:80";
}

# Default vars for auth_request policy headers.
map "" $required_scope {
  default "";
}

map "" $required_role {
  default "";
}

map "" $authz_header_forward {
  default "";
}

map "" $tenant_header_forward {
  default "";
}

# ----------------------------------------
# Request-ID / Trace Context
# ----------------------------------------
map $http_x_request_id $request_id_from_client {
  default "";
  ~^[A-Za-z0-9._:-][A-Za-z0-9._:-][A-Za-z0-9._:-][A-Za-z0-9._:-][A-Za-z0-9._:-][A-Za-z0-9._:-][A-Za-z0-9._:-][A-Za-z0-9._:-].*$ $http_x_request_id;
}

map $request_id_from_client $gateway_request_id {
  default $request_id;
  ~.+     $request_id_from_client;
}

map $http_traceparent $traceparent_safe {
  default "";
  ~^[0-9a-f][0-9a-f]-[0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f]-[0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f]-[0-9a-f][0-9a-f]$ $http_traceparent;
}

map $http_tracestate $tracestate_safe {
  default "";
  "~^[A-Za-z0-9=_\\-@,.:/]*$" $http_tracestate;
}

map $http_origin $cors_origin {
  default                 "";
  "http://localhost:5173" "http://localhost:5173";
  "http://localhost:8080" "http://localhost:8080";
}

map $cors_origin $cors_allow_origin {
  default "";
  ~.+     $cors_origin;
}

map $cors_allow_origin $cors_allow_credentials {
  default "";
  ~.+     "true";
}

# ----------------------------------------
# Header smuggling detection (duplicate-sensitive)
# NGINX merged duplicate headers often contain comma.
# ----------------------------------------
map $http_x_tenant_id $hdr_dup_tenant {
  default 0;
  ~*,.*   1;
}

map $http_x_request_id $hdr_dup_request_id {
  default 0;
  ~*,.*   1;
}

map $http_authorization $hdr_dup_authorization {
  default 0;
  ~*,.*   1;
}

map "$hdr_dup_tenant:$hdr_dup_request_id:$hdr_dup_authorization" $header_smuggling_detected {
  default 0;
  ~1      1;
}

map $http_x_tenant_id $tenant_from_header {
  default "";

  # UUID v1-5 (ohne {n}-Quantifier -> kompatibel)
  ~^[0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f]-[0-9a-f][0-9a-f][0-9a-f][0-9a-f]-[1-5][0-9a-f][0-9a-f][0-9a-f]-[89ab][0-9a-f][0-9a-f][0-9a-f]-[0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f]$ $http_x_tenant_id;
}

map $tenant_from_header $tenant_missing {
  default 0;
  ""      1;
}

# ---------------------------
# Tenant allowlist (bool)
# - default 0 (nicht erlaubt)
# - hier trÃ¤gst du bekannte Tenants ein
# ---------------------------
map $tenant_from_header $tenant_allowed {
  default 0;

  # default-tenant
  "189aa6cf-1ebb-4b76-a134-bc3c35f1df24" 1;

  # demo
  "cdc4d610-b5e2-4f8d-8a8b-d96230b811a7" 1;

  # acme
  "406b5b62-118c-45cc-a9e0-5f26b14f77e0" 1;

  # auth-flow (optional)
  "54c67e2b-7838-4733-a980-ab8a908198af" 1;

  # sandbox (optional)
  "b655229d-2507-4a72-8edc-ae838a1d7080" 1;
}

# ---------------------------
# Tenant unknown (bool)
# - deaktiviert (immer 0)
# ---------------------------
map "$tenant_missing:$tenant_allowed" $tenant_unknown {
  default 0;
}

map $request_uri $skip_tenant_check {
  # default: tenant check AUS
  default      1;
  # explizite Ausnahmen
  ~^/auth/healthz$ 1;
  ~^/auth/login($|\\?) 1;
  # auth ist identity-first: tenant wird erst fuer business APIs relevant
  ~^/auth/     1;
  ~^/profiles/ 0;
  ~^/profile/  0;
  ~^/readings  0;
}

# ---------------------------
# Tenant skip: unknown
# - z.B. /auth/ nutzt auth_request statt Allowlist
# ---------------------------
map $request_uri $skip_tenant_unknown_check {
  default   $skip_tenant_check;
  ~^/auth/  1;
}

# ---------------------------
# Tenant reject: missing
# - 1 wenn Tenant fehlt UND NICHT skip
# ---------------------------
map "$skip_tenant_check:$tenant_missing" $tenant_reject_missing {
  default 0;
  "0:1"   1;
}

# ---------------------------
# Tenant reject: unknown
# - 1 wenn Tenant unbekannt UND NICHT skip
# ---------------------------
map "$skip_tenant_unknown_check:$tenant_unknown" $tenant_reject_unknown {
  default 0;
  "0:1"   1;
}

# ---------------------------
# COMPAT: legacy tenant_reject
# ---------------------------
map "$tenant_reject_missing:$tenant_reject_unknown" $tenant_reject {
  default 0;
  "1:0"   1;
  "0:1"   1;
  "1:1"   1;
}

# ----------------------------------------
# Tenant+IP+Route limit key for auth endpoints
# - mind. fuer /auth/login und /auth/refresh getrennte Buckets
# ----------------------------------------
map $tenant_from_header $auth_tenant_for_limit {
  default $tenant_from_header;
  ""      "no-tenant";
}

map $uri $auth_rate_route {
  default       "auth-other";
  /auth/login   "auth-login";
  /auth/refresh "auth-refresh";
}

map "$binary_remote_addr:$auth_tenant_for_limit:$auth_rate_route" $auth_limit_key {
  default $binary_remote_addr:$auth_tenant_for_limit:$auth_rate_route;
}
